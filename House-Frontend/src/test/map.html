<template>
  <el-row style="height: 100vh">
    <!-- 左侧地图区域 -->
    <el-col :span="16" style="position: relative;">
      <el-select v-model="selectedCity" placeholder="选择城市" @change="onCityChange" style="margin: 10px; z-index: 10; position: absolute; top: 10px; left: 10px;">
        <el-option v-for="city in cities" :key="city" :label="city" :value="city" />
      </el-select>
      <div id="mapContainer" style="height: 100%; width: 100%"></div>
    </el-col>

    <!-- 右侧房源卡片区域 -->
    <el-col :span="8" style="padding: 20px; overflow-y: auto;">
      <el-card v-if="selectedHouse" :key="selectedHouse.houseId" style="margin-bottom: 20px">
        <img :src="selectedHouse.img" alt="房源图片" style="width: 100%; height: 180px; object-fit: cover" />
        <h3>{{ selectedHouse.title }}</h3>
        <p>{{ selectedHouse.address }}</p>
        <p>{{ selectedHouse.rent }} 元/月 | {{ selectedHouse.area }}㎡</p>
        <el-button type="primary" @click="goToDetail(selectedHouse.houseId)">查看详情</el-button>
      </el-card>
      <p v-else>请点击地图中的房源点查看详情</p>
    </el-col>
  </el-row>
</template>

<script>
import axios from 'axios'
export default {
  data() {
    return {
      cities: ['北京市', '苏州市', '桂林市', '贵阳市'],
      selectedCity: '苏州市',
      selectedHouse: null,
      map: null,
      markers: []
    }
  },
  methods: {
    initMap() {
      this.map = new window.AMap.Map('mapContainer', {
        zoom: 12,
        center: [120.619585, 31.299379] // 默认苏州市
      })
      this.loadHouses()
    },
    async loadHouses() {
      try {
        const token = localStorage.getItem('token') || ''
        const res = await axios.get('http://www.xzzf.xyz/house/find', {
          params: {
            currentPage: 1,
            pageSize: 100,
            house: { region: this.selectedCity }
          },
          headers: {
            Authorization: 'Bearer ' + token
          }
        })
        if (res.data.code === 200 && res.data.jsonData.records) {
          this.addMarkers(res.data.jsonData.records)
        }
      } catch (err) {
        this.$message.error('加载房源失败: ' + err.message)
      }
    },
    addMarkers(houses) {
      this.clearMarkers()
      houses.forEach(house => {
        if (!house.longitude || !house.latitude) return
        const marker = new window.AMap.Marker({
          position: [house.longitude, house.latitude],
          title: house.title,
          map: this.map
        })
        marker.on('click', () => {
          this.selectedHouse = house
        })
        this.markers.push(marker)
      })
    },
    clearMarkers() {
      this.markers.forEach(marker => marker.setMap(null))
      this.markers = []
    },
    async onCityChange(city) {
      try {
        const citySearch = new window.AMap.CitySearch()
        citySearch.getLocalCity(async status => {
          if (status === 'complete') {
            const geocoder = new window.AMap.Geocoder()
            geocoder.getLocation(city, (status, result) => {
              if (status === 'complete' && result.geocodes.length) {
                const location = result.geocodes[0].location
                this.map.setCenter([location.lng, location.lat])
                this.loadHouses()
              }
            })
          }
        })
      } catch (err) {
        this.$message.error('定位城市失败')
      }
    },
    goToDetail(id) {
      this.$router.push(`/house/detail/${id}`)
    }
  },
  mounted() {
    this.initMap()
  }
}
</script>

<style scoped>
#mapContainer {
  height: 100%;
  width: 100%;
}
</style>

<!-- 注意：请在 index.html 中引入高德地图 API -->
<!-- <script src="https://webapi.amap.com/maps?v=2.0&key=你的key"></script> -->
